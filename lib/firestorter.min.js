"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("mobx"),t=require("firebase/firestore"),r=require("firebase/app"),o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var n,i=function(){return(i=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function s(e,t,r,o){return new(r||(r=Promise))(function(n,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}u((o=o.apply(e,t||[])).next())})}function a(e,t){var r,o,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}(n=exports.Mode||(exports.Mode={})).Auto="auto",n.On="on",n.Off="off";var u=require("lodash.isequal");function c(e,r,o){var n=i({},e),s=t.deleteField();for(var a in r)if(r.hasOwnProperty(a)){for(var c=r[a],h=s.isEqual?s.isEqual(c):u(s,c),l=a.split("."),d=n,f=0;f<l.length-1;f++){if(void 0===d[l[f]]){if(h){d=void 0;break}d[l[f]]={}}else d[l[f]]=i({},d[l[f]]);d=d[l[f]]}h?d&&delete d[l[l.length-1]]:d[l[l.length-1]]=c}return n}function h(e){switch(e){case"auto":case"off":case"on":return e;default:throw new Error("Invalid mode mode: "+e)}}function l(t,r){var o=Array.isArray(t)?e.observable.array(t):e.observable.box(t),n=!1;return e.onBecomeUnobserved(o,void 0,function(){n&&(n=!1,r.releaseObserverRef())}),e.onBecomeObserved(o,void 0,function(){n||(n=!0,r.addObserverRef())}),o}var d,f="firestorter";function b(e){var o=(null===e||void 0===e?void 0:e.app)?"string"==typeof e.app?r.getApp(e.app):e.app:r.getApp(),n=(null===e||void 0===e?void 0:e.firestore)||t.getFirestore(o);if(!n)throw new Error("getFirestore() returned `undefined`, did you forget `import 'firebase/firestore';` ?");try{t.deleteField()}catch(e){throw new Error("Invalid `firebase` argument specified: `FieldValue.delete` does not exist")}return{app:o,firestore:n}}function p(e,t){try{var r=function(e){if(null===e||void 0===e?void 0:e.context)return e.context;if(d)return d;if(e)throw new Error("No context for "+e+" or globally. Did you forget to call `initFirestorter` or pass {context: ...} option?");throw new Error("No global Firestore context. Did you forget to call `initFirestorter` ?")}(t);if(r[e])return r;throw new Error("Context does not contain "+e)}catch(t){throw new Error(f+": cannot get "+e+": "+t)}}function g(e){return p("firestore",e).firestore}var v=require("lodash.isequal");function m(e,r){return"string"==typeof e?t.doc(g(r),e):"function"==typeof e?m(e(),r):e}var y={},O=function(){function r(t,r){var o=this;void 0===r&&(r={});var n=r.schema,i=r.snapshot,s=r.snapshotOptions,a=r.mode,u=r.debug,c=r.debugName,d=r.context;this.debugInstanceName=c,this.sourceInput=t,this.ctx=d,this.refObservable=e.observable.box(m(t,this)),this.docSchema=n,this.isVerbose=u||!1,this.snapshotObservable=l(i,this),this.snapshotOptions=s,this.collectionRefCount=0,this.observedRefCount=0;var f=i?i.data(this.snapshotOptions):void 0;f&&(f=this._validateSchema(f)),this.dataObservable=l(f||y,this),this.modeObservable=e.observable.box(h(a||exports.Mode.Auto)),this.isLoadingObservable=e.observable.box(!1),this._updateSourceObserver(),a===exports.Mode.On&&e.runInAction(function(){return o._updateRealtimeUpdates()})}return Object.defineProperty(r.prototype,"schema",{get:function(){return this.docSchema},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"data",{get:function(){return this.dataObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasData",{get:function(){var e=this.snapshot;return!!e&&e.exists()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ref",{get:function(){return this.refObservable.get()},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"id",{get:function(){var e=this.refObservable.get();return e?e.id:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"path",{get:function(){var e,t=null===(e=this.refObservable)||void 0===e?void 0:e.get();if(t){for(var r=t.id;t.parent;)r=t.parent.id+"/"+r,t=t.parent;return r}},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"source",{get:function(){return this.sourceInput},set:function(t){var r=this;if(this.collectionRefCount)throw new Error("Cannot change source on Document that is controlled by a Collection");this.sourceInput!==t&&(this.sourceInput=t,this._updateSourceObserver(),e.runInAction(function(){r.refObservable.set(m(t,r)),r._updateRealtimeUpdates(!0)}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mode",{get:function(){return this.modeObservable.get()},set:function(t){var r=this;this.modeObservable.get()!==t&&(h(t),e.runInAction(function(){r.modeObservable.set(t),r._updateRealtimeUpdates()}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isActive",{get:function(){return!!this.onSnapshotUnsubscribeFn},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"snapshot",{get:function(){return this.snapshotObservable.get()},enumerable:!1,configurable:!0}),r.prototype.update=function(r){var o=this.refObservable.get();if(this.docSchema)if(this.snapshot)try{this._validateSchema(c(e.toJS(this.data),r))}catch(e){return Promise.reject(e)}else console.warn(this.debugName+" - Unable to verify schema in .update() because the document has not been fetched yet");return t.updateDoc(o,r)},r.prototype.set=function(r,o){if(this.docSchema)try{(null===o||void 0===o?void 0:o.merge)?this._validateSchema(c(e.toJS(this.data),r)):this._validateSchema(r)}catch(e){return Promise.reject(e)}return t.setDoc(this.refObservable.get(),r,o)},r.prototype.delete=function(){return t.deleteDoc(this.refObservable.get())},r.prototype.fetch=function(){return s(this,void 0,void 0,function(){var r,o,n,i=this;return a(this,function(s){switch(s.label){case 0:if(this.isVerbose&&console.debug(this.debugName+" - fetching..."),this.collectionRefCount)throw new Error("Should not call fetch on Document that is controlled by a Collection");if(this.isActive)throw new Error("Should not call fetch when real-time updating is active");if(this.isLoadingObservable.get())throw new Error("Fetch already in progress");if(!(r=this.refObservable.get()))throw new Error("No ref or path set on Document");e.runInAction(function(){i._ready(!1),i.isLoadingObservable.set(!0)}),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t.getDoc(r)];case 2:return o=s.sent(),e.runInAction(function(){i.isLoadingObservable.set(!1),i._updateFromSnapshot(o),i.isVerbose&&console.debug(i.debugName+" - fetched: "+JSON.stringify(e.toJS(i.data)))}),this._ready(!0),[3,4];case 3:throw n=s.sent(),console.log(this.debugName+" - fetch failed: "+n.message),e.runInAction(function(){i.isLoadingObservable.set(!1),i._updateFromSnapshot(void 0),i._ready(!0)}),n;case 4:return[2,this]}})})},Object.defineProperty(r.prototype,"isLoading",{get:function(){return this.dataObservable.get(),this.isLoadingObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isLoaded",{get:function(){return!!this.snapshot},enumerable:!1,configurable:!0}),r.prototype.ready=function(){return this.readyPromise=this.readyPromise||Promise.resolve(),this.readyPromise},r.prototype.toString=function(){return this.debugName},Object.defineProperty(r.prototype,"debugName",{get:function(){return(this.debugInstanceName||this.constructor.name)+" ("+this.path+")"},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),r.prototype.addObserverRef=function(){var t=this;this.isVerbose&&console.debug(this.debugName+" - addRef ("+(this.observedRefCount+1)+")");var r=++this.observedRefCount;return 1===r&&e.runInAction(function(){return t._updateRealtimeUpdates()}),r},r.prototype.releaseObserverRef=function(){var t=this;this.isVerbose&&console.debug(this.debugName+" - releaseRef ("+(this.observedRefCount-1)+")");var r=--this.observedRefCount;return r||e.runInAction(function(){return t._updateRealtimeUpdates()}),r},r.prototype.addCollectionRef=function(){return++this.collectionRefCount},r.prototype.releaseCollectionRef=function(){return--this.collectionRefCount},r.prototype.updateFromCollectionSnapshot=function(e){return this._updateFromSnapshot(e)},r.prototype._updateFromSnapshot=function(e){var t=e?e.data(this.snapshotOptions):void 0;t=t?this._validateSchema(t):{},this.snapshotObservable.set(e),v(t,this.dataObservable.get())||this.dataObservable.set(t)},r.prototype._ready=function(e){var t=this;if(e){var r=this.readyResolveFn;r&&(this.readyResolveFn=void 0,r())}else this.readyResolveFn||(this.readyPromise=new Promise(function(e){t.readyResolveFn=e}))},r.prototype._onSnapshot=function(t){var r=this;e.runInAction(function(){r.isVerbose&&console.debug(r.debugName+" - onSnapshot"),r.isLoadingObservable.set(!1);try{r._updateFromSnapshot(t)}catch(e){console.error(e.message)}r._ready(!0)})},r.prototype._onSnapshotError=function(e){console.warn(this.debugName+" - onSnapshotError: "+e.message)},r.prototype._updateRealtimeUpdates=function(e){var r=this,o=!1;switch(this.modeObservable.get()){case exports.Mode.Auto:o=!!this.observedRefCount;break;case exports.Mode.Off:o=!1;break;case exports.Mode.On:o=!0}!this.collectionRefCount&&this.refObservable.get()||(o=!1);var n=!!this.onSnapshotUnsubscribeFn;!o||n&&!e?!o&&n&&(this.isVerbose&&console.debug(this.debugName+" - stop ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this.onSnapshotUnsubscribeFn(),this.onSnapshotUnsubscribeFn=void 0,this.isLoadingObservable.get()&&this.isLoadingObservable.set(!1),this._ready(!0)):(this.isVerbose&&console.debug(this.debugName+" - "+(n?"re-":"")+"start ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this._ready(!1),this.isLoadingObservable.set(!0),this.onSnapshotUnsubscribeFn&&this.onSnapshotUnsubscribeFn(),this.onSnapshotUnsubscribeFn=t.onSnapshot(this.refObservable.get(),{next:function(e){return r._onSnapshot(e)},error:function(e){return r._onSnapshotError(e)}}))},r.prototype._updateSourceObserver=function(){var t=this;this.sourceDisposerFn&&(this.sourceDisposerFn(),this.sourceDisposerFn=void 0),"function"==typeof this.sourceInput&&(this.sourceDisposerFn=e.reaction(function(){return t.sourceInput()},function(r){e.runInAction(function(){t.refObservable.set(m(r,t)),t._updateRealtimeUpdates(!0)})}))},r.prototype._validateSchema=function(e){if(!this.docSchema)return e;try{e=this.docSchema(e)}catch(e){throw new Error('Invalid value at "'+e.path+'" for '+(this.debugInstanceName||this.constructor.name)+' with id "'+this.id+'": '+e.message)}return e},r}(),w=function(){function r(t,r){var o=this;void 0===r&&(r={});var n=r.query,i=r.createDocument,s=r.mode,a=r.debug,u=r.debugName,c=r.minimizeUpdates,d=void 0!==c&&c,f=r.initialLocalSnapshotDetectTime,b=void 0===f?50:f,p=r.initialLocalSnapshotDebounceTime,g=void 0===p?1e3:p,v=r.context;this.isVerbose=a||!1,this.debugInstanceName=u,this.isMinimizingUpdates=d,this.initialLocalSnapshotDetectTime=b,this.initialLocalSnapshotDebounceTime=g,this.docLookup={},this.observedRefCount=0,this.sourceInput=t,this.refObservable=e.observable.box(void 0),this.queryInput=n,this.queryRefObservable=e.observable.box(void 0),this.modeObservable=e.observable.box(h(s||exports.Mode.Auto)),this.isLoadingObservable=e.observable.box(!1),this.isLoadedObservable=e.observable.box(!1),this.hasDocsObservable=l(!1,this),this.docsObservable=l([],this),this.ctx=v,this.createDocument=i||function(e,t){return new O(e,t)},e.runInAction(function(){return o._updateRealtimeUpdates(!0,!0)})}return Object.defineProperty(r.prototype,"docs",{get:function(){return this.docsObservable},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasDocs",{get:function(){return this.hasDocsObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ref",{get:function(){var e=this.refObservable.get();return this.refDisposerFn||(e=this._resolveRef(this.sourceInput)),e},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"id",{get:function(){var e=this.ref;return e?e.id:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"path",{get:function(){var e=this.ref;if(e){for(var t=e.id;e.parent;)t=e.parent.id+"/"+t,e=e.parent;return t}},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"source",{get:function(){return this.sourceInput},set:function(t){var r=this;this.sourceInput!==t&&e.runInAction(function(){r.sourceInput=t,r.refDisposerFn&&(r.refDisposerFn(),r.refDisposerFn=void 0),r._updateRealtimeUpdates(!0)})},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"query",{get:function(){return this.queryInput},set:function(t){var r=this;this.queryInput!==t&&e.runInAction(function(){r.queryInput=t,r.refDisposerFn&&(r.refDisposerFn(),r.refDisposerFn=void 0),r._updateRealtimeUpdates(void 0,!0)})},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"queryRef",{get:function(){return this.queryRefObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"mode",{get:function(){return this.modeObservable.get()},set:function(t){var r=this;this.modeObservable.get()!==t&&(h(t),e.runInAction(function(){r.modeObservable.set(t),r._updateRealtimeUpdates()}))},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isActive",{get:function(){return!!this.onSnapshotUnsubscribe},enumerable:!1,configurable:!0}),r.prototype.fetch=function(){return s(this,void 0,void 0,function(){var r,o,n,i,s,u=this;return a(this,function(a){switch(a.label){case 0:if(this.isVerbose&&console.debug(this.debugName+" - fetching..."),this.isActive)throw new Error("Should not call fetch when real-time updating is active");if(this.isLoadingObservable.get())throw new Error("Fetch already in progress");if(r=this._resolveRef(this.sourceInput),o=this._resolveQuery(r,this.queryInput),!(n=void 0!==o?o:r))throw new Error("No ref, path or query set on Collection");e.runInAction(function(){u._ready(!1),u.isLoadingObservable.set(!0)}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,t.getDocs(n)];case 2:return i=a.sent(),e.runInAction(function(){u.isLoadingObservable.set(!1),u._updateFromSnapshot(i),u.isVerbose&&console.debug(u.debugName+" - fetched "+i.docs.length+" documents")}),this._ready(!0),[2,this];case 3:throw s=a.sent(),console.log(this.debugName+" - fetch failed: "+s.message),e.runInAction(function(){u.isLoadingObservable.set(!1),u._updateFromSnapshot(void 0),u._ready(!0)}),s;case 4:return[2]}})})},Object.defineProperty(r.prototype,"isLoading",{get:function(){return this.docsObservable.length,this.isLoadingObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isLoaded",{get:function(){return this.docsObservable.length,this.isLoadedObservable.get()},enumerable:!1,configurable:!0}),r.prototype.ready=function(){return this.readyPromise=this.readyPromise||Promise.resolve(null),this.readyPromise},r.prototype.add=function(e){return s(this,void 0,void 0,function(){var r,o,n;return a(this,function(i){switch(i.label){case 0:if(!(r=this.ref))throw new Error("No valid collection reference");return this.createDocument(void 0,{context:this.context,snapshot:{data:function(){return e},exists:function(){return!0},get:function(t){return e[t]},id:"",metadata:void 0,ref:void 0}}),[4,t.addDoc(r,e)];case 1:return o=i.sent(),[4,t.getDoc(o)];case 2:return n=i.sent(),[2,this.createDocument(n.ref,{context:this.context,snapshot:n})]}})})},r.prototype.deleteAll=function(){return s(this,void 0,void 0,function(){return a(this,function(e){if(!this.ref)throw new Error("No valid collection reference");return[2]})})},r.prototype.toString=function(){return this.debugName},Object.defineProperty(r.prototype,"debugName",{get:function(){return(this.debugInstanceName||this.constructor.name)+" ("+this.path+")"},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),r.prototype.addObserverRef=function(){var t=this;this.isVerbose&&console.debug(this.debugName+" - addRef ("+(this.observedRefCount+1)+")");var r=++this.observedRefCount;return 1===r&&e.runInAction(function(){return t._updateRealtimeUpdates()}),r},r.prototype.releaseObserverRef=function(){var t=this;this.isVerbose&&console.debug(this.debugName+" - releaseRef ("+(this.observedRefCount-1)+")");var r=--this.observedRefCount;return r||e.runInAction(function(){return t._updateRealtimeUpdates()}),r},r.prototype._ready=function(e){var t=this;if(e){var r=this.readyResolveFn;r&&(this.readyResolveFn=void 0,r())}else this.readyResolveFn||(this.readyPromise=new Promise(function(e){t.readyResolveFn=e}))},r.prototype._resolveRef=function(e){if(this.sourceCache===e)return this.sourceCacheRef;var r;if("string"==typeof e)r=t.collection(g(this),e);else{if("function"==typeof e)return r=this._resolveRef(e());r=e}return this.sourceCache=e,this.sourceCacheRef=r,r},r.prototype._resolveQuery=function(e,t){var r=t;return"function"==typeof t&&(r=t(e)),r},r.prototype._onSnapshot=function(t){var r=this;if(this.initialLocalSnapshotDebounceTimer&&(clearTimeout(this.initialLocalSnapshotDebounceTimer),this.initialLocalSnapshotDebounceTimer=void 0,this.isVerbose&&console.debug(this.debugName+" - cancelling initial debounced snapshot, because a newer snapshot has been received")),this.isMinimizingUpdates){var o=Date.now()-this.initialLocalSnapshotStartTime;if(this.initialLocalSnapshotStartTime=0,o>=0&&o<this.initialLocalSnapshotDetectTime)return this.isVerbose&&console.debug(this.debugName+" - local snapshot detected ("+o+"ms < "+this.initialLocalSnapshotDetectTime+"ms threshold), debouncing "+this.initialLocalSnapshotDebounceTime+" msec..."),void(this.initialLocalSnapshotDebounceTimer=setTimeout(function(){r.initialLocalSnapshotDebounceTimer=void 0,r._onSnapshot(t)},this.initialLocalSnapshotDebounceTime))}e.runInAction(function(){r.isVerbose&&console.debug(r.debugName+" - onSnapshot"),r.isLoadingObservable.set(!1),r._updateFromSnapshot(t),r._ready(!0)})},r.prototype._onSnapshotError=function(e){console.warn(this.debugName+" - onSnapshotError: "+e.message)},r.prototype._updateFromSnapshot=function(e){var t=this,r=[];if(e&&e.docs.forEach(function(e){var o=t.docLookup[e.id];try{o?o.updateFromCollectionSnapshot(e):(o=t.createDocument(e.ref,{context:t.context,snapshot:e}),t.docLookup[o.id]=o),o.addCollectionRef(),r.push(o)}catch(e){console.error(e.message)}}),this.docsObservable.forEach(function(e){e.releaseCollectionRef()||delete t.docLookup[e.id||""]}),this.hasDocsObservable.set(!!r.length),this.isLoadedObservable.set(!0),this.docsObservable.length!==r.length)this.docsObservable.replace(r);else for(var o=0,n=r.length;o<n;o++)if(r[o]!==this.docsObservable[o]){this.docsObservable.replace(r);break}},r.prototype._updateRealtimeUpdates=function(r,o){var n=this,i=!1,s=!!this.onSnapshotUnsubscribe;switch(this.modeObservable.get()){case exports.Mode.Auto:i=!!this.observedRefCount;break;case exports.Mode.Off:i=!1;break;case exports.Mode.On:i=!0}if(i&&!s&&(r=!0,o=!0),r&&this.refObservable.set(this._resolveRef(this.sourceInput)),o&&this.queryRefObservable.set(this._resolveQuery(this.refObservable.get(),this.queryInput)),!i)return this.refDisposerFn&&(this.refDisposerFn(),this.refDisposerFn=void 0),this.onSnapshotRefCache=void 0,void(this.onSnapshotUnsubscribe&&(this.isVerbose&&console.debug(this.debugName+" - stop ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this.onSnapshotUnsubscribe(),this.onSnapshotUnsubscribe=void 0,this.isLoadingObservable.get()&&this.isLoadingObservable.set(!1),this._ready(!0)));if(!this.refDisposerFn){var a=this.refObservable.get(),u=this.queryRefObservable.get();this.refDisposerFn=e.reaction(function(){var e=n._resolveRef(n.sourceInput),t=n._resolveQuery(e,n.queryInput);return a&&(e=a,t=u,a=void 0,u=void 0),{queryRef2:t,sourceRef:e}},function(t){var r=t.sourceRef,o=t.queryRef2;e.runInAction(function(){n.refObservable.get()===r&&n.queryRefObservable.get()===o||(n.refObservable.set(r),n.queryRefObservable.set(o),n._updateRealtimeUpdates())})})}var c=this.queryRefObservable.get(),h=void 0!==c?c:this.refObservable.get();this.onSnapshotRefCache!==h&&(this.onSnapshotRefCache=h,this.onSnapshotUnsubscribe&&(this.onSnapshotUnsubscribe(),this.onSnapshotUnsubscribe=void 0),h?(this.isVerbose&&console.debug(this.debugName+" - "+(s?"re-":"")+"start ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this._ready(!1),this.isLoadingObservable.set(!0),this.initialLocalSnapshotStartTime=Date.now(),this.onSnapshotUnsubscribe=t.onSnapshot(h,{next:function(e){return n._onSnapshot(e)},error:function(e){return n._onSnapshotError(e)}})):this.docsObservable.length&&this._updateFromSnapshot({docChanges:function(e){return[]},docs:[],empty:!0,forEach:function(){return!0},metadata:void 0,query:c,size:0}))},r}(),R=require("lodash.isequal"),S=function(){function t(t,r){var o=this;this.observedRefCount=0,this._onCreateDocument=function(e,t){return e&&(e.id?o.documentRecycleMap[e.id]:null)||o.createDocument(e,t)},e.makeObservable(this,{docs:e.computed}),this.collectionSource=t,r.createDocument?this.createDocument=r.createDocument:this.createDocument=function(e,t){return new O(e,t)},this.queriesFn=r.queries,this.orderBy=r.orderBy,this.filterBy=r.filterBy,this.debug=r.debug||!1,this.debugInstanceName=r.debugName,this.collections=l([],this),this.prevCollections=[],this.collectionRecycleMap={},this.documentRecycleMap={},this.ctx=r.context}return Object.defineProperty(t.prototype,"docs",{get:function(){var e=[],t=!0;return this.collections.forEach(function(r){r.isLoading&&(t=!1),r.docs.forEach(function(t){return e.push(t)})}),!t&&this.prevCollections.length?(e=[],this.prevCollections.forEach(function(t){t.docs.forEach(function(t){return e.push(t)})})):t&&(this.prevCollections=this.collections.slice(0)),this.filterBy&&(e=e.filter(this.filterBy)),this.orderBy&&e.sort(this.orderBy),e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasDocs",{get:function(){return this.docs.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cols",{get:function(){return this.collections},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queries",{get:function(){return this.queriesFn},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoading",{get:function(){return this.collections.reduce(function(e,t){return e||t.isLoading},!1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLoaded",{get:function(){return this.collections.reduce(function(e,t){return!!e&&t.isLoaded},!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"debugName",{get:function(){return""+(this.debugInstanceName||this.constructor.name)},enumerable:!1,configurable:!0}),t.prototype.toString=function(){return this.debugName},Object.defineProperty(t.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),t.prototype.addObserverRef=function(){var t=this,r=++this.observedRefCount;return 1===r&&(this.disposer=e.autorun(function(){var r=t.queriesFn();e.runInAction(function(){return t._updateQueries(r)})})),r},t.prototype.releaseObserverRef=function(){var e=--this.observedRefCount;return e<=0&&this.disposer&&(this.disposer(),this.disposer=void 0),e},t.prototype._updateQueries=function(e){var t=this;if(e){this.debug&&console.debug(this.debugName,"updateQueries: ",e),this.documentRecycleMap={},Object.values(this.collectionRecycleMap).forEach(function(e){e.docs.forEach(function(e){t.documentRecycleMap[e.id]=e})});var r=e.map(function(e){var r=t.collectionRecycleMap[e.key];return r||(r=new w(t.collectionSource,{createDocument:t._onCreateDocument,debug:t.debug,debugName:t.debugName+".col: "+e.key,query:function(t){return t?e.query(t):t}})),r});this.collectionRecycleMap={},r.forEach(function(r,o){var n=e[o];t.collectionRecycleMap[n.key]=r}),R(r,this.collections.slice(0))||this.collections.replace(r)}},t}(),x=10,_="0123456789bcdefghjkmnpqrstuvwxyz",D=40007860,P=110574,E=5,F=22*E,M=6378137,I=.00669447819799,N=1e-12;function j(e){return{latitude:e[0],longitude:e[1]}}function C(e){return Math.log(e)/Math.log(2)}function L(e){if("number"!=typeof e||isNaN(e))throw new Error("latitude must be a number");if(e<-90||e>90)throw new Error("latitude must be within the range [-90, 90]")}function q(e){if("number"!=typeof e||isNaN(e))throw new Error("longitude must be a number");if(e<-180||e>180)throw new Error("longitude must be within the range [-180, 180]")}function A(e){try{if(!e)throw new Error("location is empty");L(e.latitude),q(e.longitude)}catch(t){throw new Error('Invalid location "'+e+'": '+t.message)}}function U(e){var t,r,o;if("string"!=typeof e)o="geohash must be a string";else if(0===e.length)o="geohash cannot be the empty string";else try{for(var n=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],o=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),i=n.next();!i.done;i=n.next()){var s=i.value;-1===_.indexOf(s)&&(o="geohash cannot contain '"+s+"'")}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}if(void 0!==o)throw new Error("Invalid geohash '"+e+"': "+o)}function T(e){var t=e.latitude-.5*e.latitudeDelta,r=e.latitude+.5*e.latitudeDelta,o=z(e.longitude+.5*e.longitudeDelta),n=z(e.longitude-.5*e.longitudeDelta);return{northEast:{latitude:t,longitude:o},northWest:{latitude:t,longitude:n},southEast:{latitude:r,longitude:o},southWest:{latitude:r,longitude:n}}}function k(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180}function V(e,t){if(void 0===t&&(t=x),A(e),void 0!==t){if("number"!=typeof t||isNaN(t))throw new Error("precision must be a number");if(t<=0)throw new Error("precision must be greater than 0");if(t>22)throw new Error("precision cannot be greater than 22");if(Math.round(t)!==t)throw new Error("precision must be an integer")}for(var r={max:90,min:-90},o={max:180,min:-180},n="",i=0,s=0,a=1;n.length<t;){var u=a?e.longitude:e.latitude,c=a?o:r,h=(c.min+c.max)/2;u>h?(i=1+(i<<1),c.min=h):(i=0+(i<<1),c.max=h),a=!a,s<4?s++:(s=0,n+=_[i],i=0)}return n}function B(e,t){var r=k(t),o=Math.cos(r)*M*Math.PI/180*(1/Math.sqrt(1-I*Math.sin(r)*Math.sin(r)));return o<N?e>0?360:0:Math.min(360,e/o)}function G(e,t){var r=B(e,t);return Math.abs(r)>1e-6?Math.max(1,C(360/r)):1}function Q(e){return Math.min(C(D/2/e),F)}function z(e){if(e<=180&&e>=-180)return e;var t=e+180;return t>0?t%360-180:180- -t%360}function W(e,t){U(e);var r=Math.ceil(t/E);if(e.length<r)return[e,e+"~"];var o=e.substring(0,r),n=o.substring(0,o.length-1),i=_.indexOf(o.charAt(o.length-1)),s=t-n.length*E,a=E-s,u=i>>a<<a,c=u+(1<<a);return c>31?[n+_[u],n+"~"]:[n+_[u],n+_[c]]}function J(e){!function(e){try{if(!e)throw new Error("region is empty");L(e.latitude),L(e.latitudeDelta),q(e.longitude),q(e.longitudeDelta)}catch(t){throw new Error('Invalid region "'+e+'": '+t.message)}}(e);var t=Math.max(1,function(e){var t=T(e),r=t.northEast,o=t.southEast,n=t.northWest,i=t.southWest,s=2*Math.floor(Q(.5*K(r,o))),a=2*Math.floor(G(.5*K(r,n),n.latitude))-1,u=2*Math.floor(G(.5*K(o,i),i.latitude))-1;return Math.min(s,a,u,F)}(e)),r=Math.ceil(t/E),o=function(e){var t=T(e),r=t.northEast,o=t.northWest,n=t.southWest;return[[e.latitude,e.longitude],[e.latitude,r.longitude],[e.latitude,o.longitude],[o.latitude,e.longitude],[o.latitude,r.longitude],[o.latitude,o.longitude],[n.latitude,e.longitude],[n.latitude,r.longitude],[n.latitude,o.longitude]]}(e).map(function(e){return W(V(j(e),r),t)});return o.filter(function(e,t){return!o.some(function(r,o){return t>o&&e[0]===r[0]&&e[1]===r[1]})})}function H(e,t){if(e.length!==t.length)throw new Error("Geohash lengths must be the same");for(var r=[e],o=e;o<t;)for(var n=e.length-1;n>=0;n--){var i=_.indexOf(o.charAt(n));if(i<_.length-1){(o=o.substring(0,n)+_[i+1]+o.substring(n+1))<t&&r.push(o);break}if((o=o.substring(0,n)+_[0]+o.substring(n+1))>=t)break}return r}function K(e,t){A(e),A(t);var r=k(t.latitude-e.latitude),o=k(t.longitude-e.longitude),n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(k(e.latitude))*Math.cos(k(t.latitude))*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))*1e3}var X=function(r){function n(o,n){var s=this,a=n||{},u=a.region,c=a.fieldPath,h=void 0===c?"geohash":c,l=a.filterBy,d=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(a,["region","fieldPath","filterBy"]),f=e.observable.box(u);return(s=r.call(this,o,i({filterBy:l?function(e){var t=f.get();return t="function"==typeof t?t():t,l(e,t)}:void 0,queries:function(){var e=f.get(),r=(e="function"==typeof e?e():e)?J(e):void 0;return r?r.map(function(e){return{geohash:e,key:e[0]+"-"+e[1],query:function(r){return t.query(r,t.where(h,">=",e[0]),t.where(h,"<",e[1]))}}}):null}},d))||this).regionObservable=f,e.makeObservable(s,{geohashes:e.computed}),s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(n,r),Object.defineProperty(n.prototype,"region",{get:function(){return this.regionObservable.get()},set:function(t){var r=this;e.runInAction(function(){return r.regionObservable.set(t)})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"geohashes",{get:function(){var e=this.queries();return e?e.map(function(e){return e.geohash}):[]},enumerable:!1,configurable:!0}),n}(S);exports.AggregateCollection=S,exports.Collection=w,exports.Document=O,exports.GeoQuery=X,exports.calculateGeoDistance=K,exports.decodeGeohash=function(e){U(e);for(var t=!0,r=-90,o=90,n=-180,i=180,s=0;s<e.length;s++){var a=e.charAt(s),u=_.indexOf(a);if(u<0)throw new Error("Invalid geohash");for(var c=4;c>=0;c--){var h=u>>c&1;if(t){var l=(n+i)/2;1===h?n=l:i=l}else{var d=(r+o)/2;1===h?r=d:o=d}t=!t}}return[{latitude:r,longitude:n},{latitude:o,longitude:i}]},exports.encodeGeohash=V,exports.flattenGeohashRange=H,exports.flattenGeohashes=function(e){var t=new Set;return e.forEach(function(e){return H(e[0],e[1]).forEach(function(e){return t.add(e)})}),Array.from(t)},exports.geoRegionToPoints=T,exports.getFirebaseApp=function(e){return p("app",e).app},exports.getFirestore=g,exports.getGeohashesForRadius=function(e,t){A(e);var r,o,n,i,s,a,u,c,h=Math.max(1,(r=e,n=(o=t)/P,i=Math.min(90,r.latitude+n),s=Math.max(-90,r.latitude-n),a=2*Math.floor(Q(o)),u=2*Math.floor(G(o,i))-1,c=2*Math.floor(G(o,s))-1,Math.min(a,u,c,F))),l=Math.ceil(h/E),d=function(e,t){var r=t/P,o=Math.min(90,e.latitude+r),n=Math.max(-90,e.latitude-r),i=B(t,o),s=B(t,n),a=Math.max(i,s);return[[e.latitude,e.longitude],[e.latitude,z(e.longitude-a)],[e.latitude,z(e.longitude+a)],[o,e.longitude],[o,z(e.longitude-a)],[o,z(e.longitude+a)],[n,e.longitude],[n,z(e.longitude-a)],[n,z(e.longitude+a)]]}(e,t).map(function(e){return W(V(j(e),l),h)});return d.filter(function(e,t){return!d.some(function(r,o){return t>o&&e[0]===r[0]&&e[1]===r[1]})})},exports.getGeohashesForRegion=J,exports.initFirestorter=function(e){if(d)throw new Error("Firestorter already initialized, did you accidentally call `initFirestorter()` again?");d=b(e)},exports.insideGeoRegion=function(e,t){return!(e.latitude<t.latitude-.5*t.latitudeDelta||e.latitude>t.latitude+.5*t.latitudeDelta||e.longitude<t.longitude-.5*t.longitudeDelta||e.longitude>t.longitude+.5*t.longitudeDelta)},exports.isTimestamp=function(e){return e instanceof Date||"object"==typeof e&&"number"==typeof e.seconds&&"number"==typeof e.nanoseconds},exports.makeFirestorterContext=b,exports.mergeUpdateData=c,exports.metersToLatitudeDegrees=function(e){return e/P},exports.metersToLongitudeDegrees=B;