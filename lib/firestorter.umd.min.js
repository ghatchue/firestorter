var e,t;e=this,t=function(e,t,r,o){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};var i,s=function(){return(s=Object.assign||function(e){for(var t,r=1,o=arguments.length;r<o;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function a(e,t,r,o){return new(r||(r=Promise))(function(n,i){function s(e){try{u(o.next(e))}catch(e){i(e)}}function a(e){try{u(o.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}u((o=o.apply(e,t||[])).next())})}function u(e,t){var r,o,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}(i=e.Mode||(e.Mode={})).Auto="auto",i.On="on",i.Off="off";var c=require("lodash.isequal");function h(e,t,o){var n=s({},e),i=r.deleteField();for(var a in t)if(t.hasOwnProperty(a)){for(var u=t[a],h=i.isEqual?i.isEqual(u):c(i,u),l=a.split("."),f=n,d=0;d<l.length-1;d++){if(void 0===f[l[d]]){if(h){f=void 0;break}f[l[d]]={}}else f[l[d]]=s({},f[l[d]]);f=f[l[d]]}h?f&&delete f[l[l.length-1]]:f[l[l.length-1]]=u}return n}function l(e){switch(e){case"auto":case"off":case"on":return e;default:throw new Error("Invalid mode mode: "+e)}}function f(e,r){var o=Array.isArray(e)?t.observable.array(e):t.observable.box(e),n=!1;return t.onBecomeUnobserved(o,void 0,function(){n&&(n=!1,r.releaseObserverRef())}),t.onBecomeObserved(o,void 0,function(){n||(n=!0,r.addObserverRef())}),o}var d,b="firestorter";function p(e){var t=(null===e||void 0===e?void 0:e.app)?"string"==typeof e.app?o.getApp(e.app):e.app:o.getApp(),n=(null===e||void 0===e?void 0:e.firestore)||r.getFirestore(t);if(!n)throw new Error("getFirestore() returned `undefined`, did you forget `import 'firebase/firestore';` ?");try{r.deleteField()}catch(e){throw new Error("Invalid `firebase` argument specified: `FieldValue.delete` does not exist")}return{app:t,firestore:n}}function g(e,t){try{var r=function(e){if(null===e||void 0===e?void 0:e.context)return e.context;if(d)return d;if(e)throw new Error("No context for "+e+" or globally. Did you forget to call `initFirestorter` or pass {context: ...} option?");throw new Error("No global Firestore context. Did you forget to call `initFirestorter` ?")}(t);if(r[e])return r;throw new Error("Context does not contain "+e)}catch(t){throw new Error(b+": cannot get "+e+": "+t)}}function v(e){return g("firestore",e).firestore}var m=require("lodash.isequal");function y(e,t){return"string"==typeof e?r.doc(v(t),e):"function"==typeof e?y(e(),t):e}var O={},w=function(){function o(r,o){var n=this;void 0===o&&(o={});var i=o.schema,s=o.snapshot,a=o.snapshotOptions,u=o.mode,c=o.debug,h=o.debugName,d=o.context;this.debugInstanceName=h,this.sourceInput=r,this.ctx=d,this.refObservable=t.observable.box(y(r,this)),this.docSchema=i,this.isVerbose=c||!1,this.snapshotObservable=f(s,this),this.snapshotOptions=a,this.collectionRefCount=0,this.observedRefCount=0;var b=s?s.data(this.snapshotOptions):void 0;b&&(b=this._validateSchema(b)),this.dataObservable=f(b||O,this),this.modeObservable=t.observable.box(l(u||e.Mode.Auto)),this.isLoadingObservable=t.observable.box(!1),this._updateSourceObserver(),u===e.Mode.On&&t.runInAction(function(){return n._updateRealtimeUpdates()})}return Object.defineProperty(o.prototype,"schema",{get:function(){return this.docSchema},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"data",{get:function(){return this.dataObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"hasData",{get:function(){var e=this.snapshot;return!!e&&e.exists()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"ref",{get:function(){return this.refObservable.get()},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"id",{get:function(){var e=this.refObservable.get();return e?e.id:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"path",{get:function(){var e,t=null===(e=this.refObservable)||void 0===e?void 0:e.get();if(t){for(var r=t.id;t.parent;)r=t.parent.id+"/"+r,t=t.parent;return r}},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"source",{get:function(){return this.sourceInput},set:function(e){var r=this;if(this.collectionRefCount)throw new Error("Cannot change source on Document that is controlled by a Collection");this.sourceInput!==e&&(this.sourceInput=e,this._updateSourceObserver(),t.runInAction(function(){r.refObservable.set(y(e,r)),r._updateRealtimeUpdates(!0)}))},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mode",{get:function(){return this.modeObservable.get()},set:function(e){var r=this;this.modeObservable.get()!==e&&(l(e),t.runInAction(function(){r.modeObservable.set(e),r._updateRealtimeUpdates()}))},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isActive",{get:function(){return!!this.onSnapshotUnsubscribeFn},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"snapshot",{get:function(){return this.snapshotObservable.get()},enumerable:!1,configurable:!0}),o.prototype.update=function(e){var o=this.refObservable.get();if(this.docSchema)if(this.snapshot)try{this._validateSchema(h(t.toJS(this.data),e))}catch(e){return Promise.reject(e)}else console.warn(this.debugName+" - Unable to verify schema in .update() because the document has not been fetched yet");return r.updateDoc(o,e)},o.prototype.set=function(e,o){if(this.docSchema)try{(null===o||void 0===o?void 0:o.merge)?this._validateSchema(h(t.toJS(this.data),e)):this._validateSchema(e)}catch(e){return Promise.reject(e)}return r.setDoc(this.refObservable.get(),e,o)},o.prototype.delete=function(){return r.deleteDoc(this.refObservable.get())},o.prototype.fetch=function(){return a(this,void 0,void 0,function(){var e,o,n,i=this;return u(this,function(s){switch(s.label){case 0:if(this.isVerbose&&console.debug(this.debugName+" - fetching..."),this.collectionRefCount)throw new Error("Should not call fetch on Document that is controlled by a Collection");if(this.isActive)throw new Error("Should not call fetch when real-time updating is active");if(this.isLoadingObservable.get())throw new Error("Fetch already in progress");if(!(e=this.refObservable.get()))throw new Error("No ref or path set on Document");t.runInAction(function(){i._ready(!1),i.isLoadingObservable.set(!0)}),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,r.getDoc(e)];case 2:return o=s.sent(),t.runInAction(function(){i.isLoadingObservable.set(!1),i._updateFromSnapshot(o),i.isVerbose&&console.debug(i.debugName+" - fetched: "+JSON.stringify(t.toJS(i.data)))}),this._ready(!0),[3,4];case 3:throw n=s.sent(),console.log(this.debugName+" - fetch failed: "+n.message),t.runInAction(function(){i.isLoadingObservable.set(!1),i._updateFromSnapshot(void 0),i._ready(!0)}),n;case 4:return[2,this]}})})},Object.defineProperty(o.prototype,"isLoading",{get:function(){return this.dataObservable.get(),this.isLoadingObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isLoaded",{get:function(){return!!this.snapshot},enumerable:!1,configurable:!0}),o.prototype.ready=function(){return this.readyPromise=this.readyPromise||Promise.resolve(),this.readyPromise},o.prototype.toString=function(){return this.debugName},Object.defineProperty(o.prototype,"debugName",{get:function(){return(this.debugInstanceName||this.constructor.name)+" ("+this.path+")"},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),o.prototype.addObserverRef=function(){var e=this;this.isVerbose&&console.debug(this.debugName+" - addRef ("+(this.observedRefCount+1)+")");var r=++this.observedRefCount;return 1===r&&t.runInAction(function(){return e._updateRealtimeUpdates()}),r},o.prototype.releaseObserverRef=function(){var e=this;this.isVerbose&&console.debug(this.debugName+" - releaseRef ("+(this.observedRefCount-1)+")");var r=--this.observedRefCount;return r||t.runInAction(function(){return e._updateRealtimeUpdates()}),r},o.prototype.addCollectionRef=function(){return++this.collectionRefCount},o.prototype.releaseCollectionRef=function(){return--this.collectionRefCount},o.prototype.updateFromCollectionSnapshot=function(e){return this._updateFromSnapshot(e)},o.prototype._updateFromSnapshot=function(e){var t=e?e.data(this.snapshotOptions):void 0;t=t?this._validateSchema(t):{},this.snapshotObservable.set(e),m(t,this.dataObservable.get())||this.dataObservable.set(t)},o.prototype._ready=function(e){var t=this;if(e){var r=this.readyResolveFn;r&&(this.readyResolveFn=void 0,r())}else this.readyResolveFn||(this.readyPromise=new Promise(function(e){t.readyResolveFn=e}))},o.prototype._onSnapshot=function(e){var r=this;t.runInAction(function(){r.isVerbose&&console.debug(r.debugName+" - onSnapshot"),r.isLoadingObservable.set(!1);try{r._updateFromSnapshot(e)}catch(e){console.error(e.message)}r._ready(!0)})},o.prototype._onSnapshotError=function(e){console.warn(this.debugName+" - onSnapshotError: "+e.message)},o.prototype._updateRealtimeUpdates=function(t){var o=this,n=!1;switch(this.modeObservable.get()){case e.Mode.Auto:n=!!this.observedRefCount;break;case e.Mode.Off:n=!1;break;case e.Mode.On:n=!0}!this.collectionRefCount&&this.refObservable.get()||(n=!1);var i=!!this.onSnapshotUnsubscribeFn;!n||i&&!t?!n&&i&&(this.isVerbose&&console.debug(this.debugName+" - stop ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this.onSnapshotUnsubscribeFn(),this.onSnapshotUnsubscribeFn=void 0,this.isLoadingObservable.get()&&this.isLoadingObservable.set(!1),this._ready(!0)):(this.isVerbose&&console.debug(this.debugName+" - "+(i?"re-":"")+"start ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this._ready(!1),this.isLoadingObservable.set(!0),this.onSnapshotUnsubscribeFn&&this.onSnapshotUnsubscribeFn(),this.onSnapshotUnsubscribeFn=r.onSnapshot(this.refObservable.get(),{next:function(e){return o._onSnapshot(e)},error:function(e){return o._onSnapshotError(e)}}))},o.prototype._updateSourceObserver=function(){var e=this;this.sourceDisposerFn&&(this.sourceDisposerFn(),this.sourceDisposerFn=void 0),"function"==typeof this.sourceInput&&(this.sourceDisposerFn=t.reaction(function(){return e.sourceInput()},function(r){t.runInAction(function(){e.refObservable.set(y(r,e)),e._updateRealtimeUpdates(!0)})}))},o.prototype._validateSchema=function(e){if(!this.docSchema)return e;try{e=this.docSchema(e)}catch(e){throw new Error('Invalid value at "'+e.path+'" for '+(this.debugInstanceName||this.constructor.name)+' with id "'+this.id+'": '+e.message)}return e},o}(),R=function(){function o(r,o){var n=this;void 0===o&&(o={});var i=o.query,s=o.createDocument,a=o.mode,u=o.debug,c=o.debugName,h=o.minimizeUpdates,d=void 0!==h&&h,b=o.initialLocalSnapshotDetectTime,p=void 0===b?50:b,g=o.initialLocalSnapshotDebounceTime,v=void 0===g?1e3:g,m=o.context;this.isVerbose=u||!1,this.debugInstanceName=c,this.isMinimizingUpdates=d,this.initialLocalSnapshotDetectTime=p,this.initialLocalSnapshotDebounceTime=v,this.docLookup={},this.observedRefCount=0,this.sourceInput=r,this.refObservable=t.observable.box(void 0),this.queryInput=i,this.queryRefObservable=t.observable.box(void 0),this.modeObservable=t.observable.box(l(a||e.Mode.Auto)),this.isLoadingObservable=t.observable.box(!1),this.isLoadedObservable=t.observable.box(!1),this.hasDocsObservable=f(!1,this),this.docsObservable=f([],this),this.ctx=m,this.createDocument=s||function(e,t){return new w(e,t)},t.runInAction(function(){return n._updateRealtimeUpdates(!0,!0)})}return Object.defineProperty(o.prototype,"docs",{get:function(){return this.docsObservable},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"hasDocs",{get:function(){return this.hasDocsObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"ref",{get:function(){var e=this.refObservable.get();return this.refDisposerFn||(e=this._resolveRef(this.sourceInput)),e},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"id",{get:function(){var e=this.ref;return e?e.id:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"path",{get:function(){var e=this.ref;if(e){for(var t=e.id;e.parent;)t=e.parent.id+"/"+t,e=e.parent;return t}},set:function(e){this.source=e},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"source",{get:function(){return this.sourceInput},set:function(e){var r=this;this.sourceInput!==e&&t.runInAction(function(){r.sourceInput=e,r.refDisposerFn&&(r.refDisposerFn(),r.refDisposerFn=void 0),r._updateRealtimeUpdates(!0)})},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"query",{get:function(){return this.queryInput},set:function(e){var r=this;this.queryInput!==e&&t.runInAction(function(){r.queryInput=e,r.refDisposerFn&&(r.refDisposerFn(),r.refDisposerFn=void 0),r._updateRealtimeUpdates(void 0,!0)})},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"queryRef",{get:function(){return this.queryRefObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"mode",{get:function(){return this.modeObservable.get()},set:function(e){var r=this;this.modeObservable.get()!==e&&(l(e),t.runInAction(function(){r.modeObservable.set(e),r._updateRealtimeUpdates()}))},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isActive",{get:function(){return!!this.onSnapshotUnsubscribe},enumerable:!1,configurable:!0}),o.prototype.fetch=function(){return a(this,void 0,void 0,function(){var e,o,n,i,s,a=this;return u(this,function(u){switch(u.label){case 0:if(this.isVerbose&&console.debug(this.debugName+" - fetching..."),this.isActive)throw new Error("Should not call fetch when real-time updating is active");if(this.isLoadingObservable.get())throw new Error("Fetch already in progress");if(e=this._resolveRef(this.sourceInput),o=this._resolveQuery(e,this.queryInput),!(n=void 0!==o?o:e))throw new Error("No ref, path or query set on Collection");t.runInAction(function(){a._ready(!1),a.isLoadingObservable.set(!0)}),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,r.getDocs(n)];case 2:return i=u.sent(),t.runInAction(function(){a.isLoadingObservable.set(!1),a._updateFromSnapshot(i),a.isVerbose&&console.debug(a.debugName+" - fetched "+i.docs.length+" documents")}),this._ready(!0),[2,this];case 3:throw s=u.sent(),console.log(this.debugName+" - fetch failed: "+s.message),t.runInAction(function(){a.isLoadingObservable.set(!1),a._updateFromSnapshot(void 0),a._ready(!0)}),s;case 4:return[2]}})})},Object.defineProperty(o.prototype,"isLoading",{get:function(){return this.docsObservable.length,this.isLoadingObservable.get()},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"isLoaded",{get:function(){return this.docsObservable.length,this.isLoadedObservable.get()},enumerable:!1,configurable:!0}),o.prototype.ready=function(){return this.readyPromise=this.readyPromise||Promise.resolve(null),this.readyPromise},o.prototype.add=function(e){return a(this,void 0,void 0,function(){var t,o,n;return u(this,function(i){switch(i.label){case 0:if(!(t=this.ref))throw new Error("No valid collection reference");return this.createDocument(void 0,{context:this.context,snapshot:{data:function(){return e},exists:function(){return!0},get:function(t){return e[t]},id:"",metadata:void 0,ref:void 0}}),[4,r.addDoc(t,e)];case 1:return o=i.sent(),[4,r.getDoc(o)];case 2:return n=i.sent(),[2,this.createDocument(n.ref,{context:this.context,snapshot:n})]}})})},o.prototype.deleteAll=function(){return a(this,void 0,void 0,function(){return u(this,function(e){if(!this.ref)throw new Error("No valid collection reference");return[2]})})},o.prototype.toString=function(){return this.debugName},Object.defineProperty(o.prototype,"debugName",{get:function(){return(this.debugInstanceName||this.constructor.name)+" ("+this.path+")"},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),o.prototype.addObserverRef=function(){var e=this;this.isVerbose&&console.debug(this.debugName+" - addRef ("+(this.observedRefCount+1)+")");var r=++this.observedRefCount;return 1===r&&t.runInAction(function(){return e._updateRealtimeUpdates()}),r},o.prototype.releaseObserverRef=function(){var e=this;this.isVerbose&&console.debug(this.debugName+" - releaseRef ("+(this.observedRefCount-1)+")");var r=--this.observedRefCount;return r||t.runInAction(function(){return e._updateRealtimeUpdates()}),r},o.prototype._ready=function(e){var t=this;if(e){var r=this.readyResolveFn;r&&(this.readyResolveFn=void 0,r())}else this.readyResolveFn||(this.readyPromise=new Promise(function(e){t.readyResolveFn=e}))},o.prototype._resolveRef=function(e){if(this.sourceCache===e)return this.sourceCacheRef;var t;if("string"==typeof e)t=r.collection(v(this),e);else{if("function"==typeof e)return t=this._resolveRef(e());t=e}return this.sourceCache=e,this.sourceCacheRef=t,t},o.prototype._resolveQuery=function(e,t){var r=t;return"function"==typeof t&&(r=t(e)),r},o.prototype._onSnapshot=function(e){var r=this;if(this.initialLocalSnapshotDebounceTimer&&(clearTimeout(this.initialLocalSnapshotDebounceTimer),this.initialLocalSnapshotDebounceTimer=void 0,this.isVerbose&&console.debug(this.debugName+" - cancelling initial debounced snapshot, because a newer snapshot has been received")),this.isMinimizingUpdates){var o=Date.now()-this.initialLocalSnapshotStartTime;if(this.initialLocalSnapshotStartTime=0,o>=0&&o<this.initialLocalSnapshotDetectTime)return this.isVerbose&&console.debug(this.debugName+" - local snapshot detected ("+o+"ms < "+this.initialLocalSnapshotDetectTime+"ms threshold), debouncing "+this.initialLocalSnapshotDebounceTime+" msec..."),void(this.initialLocalSnapshotDebounceTimer=setTimeout(function(){r.initialLocalSnapshotDebounceTimer=void 0,r._onSnapshot(e)},this.initialLocalSnapshotDebounceTime))}t.runInAction(function(){r.isVerbose&&console.debug(r.debugName+" - onSnapshot"),r.isLoadingObservable.set(!1),r._updateFromSnapshot(e),r._ready(!0)})},o.prototype._onSnapshotError=function(e){console.warn(this.debugName+" - onSnapshotError: "+e.message)},o.prototype._updateFromSnapshot=function(e){var t=this,r=[];if(e&&e.docs.forEach(function(e){var o=t.docLookup[e.id];try{o?o.updateFromCollectionSnapshot(e):(o=t.createDocument(e.ref,{context:t.context,snapshot:e}),t.docLookup[o.id]=o),o.addCollectionRef(),r.push(o)}catch(e){console.error(e.message)}}),this.docsObservable.forEach(function(e){e.releaseCollectionRef()||delete t.docLookup[e.id||""]}),this.hasDocsObservable.set(!!r.length),this.isLoadedObservable.set(!0),this.docsObservable.length!==r.length)this.docsObservable.replace(r);else for(var o=0,n=r.length;o<n;o++)if(r[o]!==this.docsObservable[o]){this.docsObservable.replace(r);break}},o.prototype._updateRealtimeUpdates=function(o,n){var i=this,s=!1,a=!!this.onSnapshotUnsubscribe;switch(this.modeObservable.get()){case e.Mode.Auto:s=!!this.observedRefCount;break;case e.Mode.Off:s=!1;break;case e.Mode.On:s=!0}if(s&&!a&&(o=!0,n=!0),o&&this.refObservable.set(this._resolveRef(this.sourceInput)),n&&this.queryRefObservable.set(this._resolveQuery(this.refObservable.get(),this.queryInput)),!s)return this.refDisposerFn&&(this.refDisposerFn(),this.refDisposerFn=void 0),this.onSnapshotRefCache=void 0,void(this.onSnapshotUnsubscribe&&(this.isVerbose&&console.debug(this.debugName+" - stop ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this.onSnapshotUnsubscribe(),this.onSnapshotUnsubscribe=void 0,this.isLoadingObservable.get()&&this.isLoadingObservable.set(!1),this._ready(!0)));if(!this.refDisposerFn){var u=this.refObservable.get(),c=this.queryRefObservable.get();this.refDisposerFn=t.reaction(function(){var e=i._resolveRef(i.sourceInput),t=i._resolveQuery(e,i.queryInput);return u&&(e=u,t=c,u=void 0,c=void 0),{queryRef2:t,sourceRef:e}},function(e){var r=e.sourceRef,o=e.queryRef2;t.runInAction(function(){i.refObservable.get()===r&&i.queryRefObservable.get()===o||(i.refObservable.set(r),i.queryRefObservable.set(o),i._updateRealtimeUpdates())})})}var h=this.queryRefObservable.get(),l=void 0!==h?h:this.refObservable.get();this.onSnapshotRefCache!==l&&(this.onSnapshotRefCache=l,this.onSnapshotUnsubscribe&&(this.onSnapshotUnsubscribe(),this.onSnapshotUnsubscribe=void 0),l?(this.isVerbose&&console.debug(this.debugName+" - "+(a?"re-":"")+"start ("+this.modeObservable.get()+":"+this.observedRefCount+")"),this._ready(!1),this.isLoadingObservable.set(!0),this.initialLocalSnapshotStartTime=Date.now(),this.onSnapshotUnsubscribe=r.onSnapshot(l,{next:function(e){return i._onSnapshot(e)},error:function(e){return i._onSnapshotError(e)}})):this.docsObservable.length&&this._updateFromSnapshot({docChanges:function(e){return[]},docs:[],empty:!0,forEach:function(){return!0},metadata:void 0,query:h,size:0}))},o}(),S=require("lodash.isequal"),_=function(){function e(e,r){var o=this;this.observedRefCount=0,this._onCreateDocument=function(e,t){return e&&(e.id?o.documentRecycleMap[e.id]:null)||o.createDocument(e,t)},t.makeObservable(this,{docs:t.computed}),this.collectionSource=e,r.createDocument?this.createDocument=r.createDocument:this.createDocument=function(e,t){return new w(e,t)},this.queriesFn=r.queries,this.orderBy=r.orderBy,this.filterBy=r.filterBy,this.debug=r.debug||!1,this.debugInstanceName=r.debugName,this.collections=f([],this),this.prevCollections=[],this.collectionRecycleMap={},this.documentRecycleMap={},this.ctx=r.context}return Object.defineProperty(e.prototype,"docs",{get:function(){var e=[],t=!0;return this.collections.forEach(function(r){r.isLoading&&(t=!1),r.docs.forEach(function(t){return e.push(t)})}),!t&&this.prevCollections.length?(e=[],this.prevCollections.forEach(function(t){t.docs.forEach(function(t){return e.push(t)})})):t&&(this.prevCollections=this.collections.slice(0)),this.filterBy&&(e=e.filter(this.filterBy)),this.orderBy&&e.sort(this.orderBy),e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasDocs",{get:function(){return this.docs.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cols",{get:function(){return this.collections},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"queries",{get:function(){return this.queriesFn},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoading",{get:function(){return this.collections.reduce(function(e,t){return e||t.isLoading},!1)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){return this.collections.reduce(function(e,t){return!!e&&t.isLoaded},!0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"debugName",{get:function(){return""+(this.debugInstanceName||this.constructor.name)},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return this.debugName},Object.defineProperty(e.prototype,"context",{get:function(){return this.ctx},enumerable:!1,configurable:!0}),e.prototype.addObserverRef=function(){var e=this,r=++this.observedRefCount;return 1===r&&(this.disposer=t.autorun(function(){var r=e.queriesFn();t.runInAction(function(){return e._updateQueries(r)})})),r},e.prototype.releaseObserverRef=function(){var e=--this.observedRefCount;return e<=0&&this.disposer&&(this.disposer(),this.disposer=void 0),e},e.prototype._updateQueries=function(e){var t=this;if(e){this.debug&&console.debug(this.debugName,"updateQueries: ",e),this.documentRecycleMap={},Object.values(this.collectionRecycleMap).forEach(function(e){e.docs.forEach(function(e){t.documentRecycleMap[e.id]=e})});var r=e.map(function(e){var r=t.collectionRecycleMap[e.key];return r||(r=new R(t.collectionSource,{createDocument:t._onCreateDocument,debug:t.debug,debugName:t.debugName+".col: "+e.key,query:function(t){return t?e.query(t):t}})),r});this.collectionRecycleMap={},r.forEach(function(r,o){var n=e[o];t.collectionRecycleMap[n.key]=r}),S(r,this.collections.slice(0))||this.collections.replace(r)}},e}(),D=10,x="0123456789bcdefghjkmnpqrstuvwxyz",P=40007860,E=110574,F=5,M=22*F,I=6378137,j=.00669447819799,N=1e-12;function C(e){return{latitude:e[0],longitude:e[1]}}function L(e){return Math.log(e)/Math.log(2)}function q(e){if("number"!=typeof e||isNaN(e))throw new Error("latitude must be a number");if(e<-90||e>90)throw new Error("latitude must be within the range [-90, 90]")}function A(e){if("number"!=typeof e||isNaN(e))throw new Error("longitude must be a number");if(e<-180||e>180)throw new Error("longitude must be within the range [-180, 180]")}function U(e){try{if(!e)throw new Error("location is empty");q(e.latitude),A(e.longitude)}catch(t){throw new Error('Invalid location "'+e+'": '+t.message)}}function T(e){var t,r,o;if("string"!=typeof e)o="geohash must be a string";else if(0===e.length)o="geohash cannot be the empty string";else try{for(var n=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],o=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),i=n.next();!i.done;i=n.next()){var s=i.value;-1===x.indexOf(s)&&(o="geohash cannot contain '"+s+"'")}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}if(void 0!==o)throw new Error("Invalid geohash '"+e+"': "+o)}function k(e){var t=e.latitude-.5*e.latitudeDelta,r=e.latitude+.5*e.latitudeDelta,o=W(e.longitude+.5*e.longitudeDelta),n=W(e.longitude-.5*e.longitudeDelta);return{northEast:{latitude:t,longitude:o},northWest:{latitude:t,longitude:n},southEast:{latitude:r,longitude:o},southWest:{latitude:r,longitude:n}}}function V(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180}function B(e,t){if(void 0===t&&(t=D),U(e),void 0!==t){if("number"!=typeof t||isNaN(t))throw new Error("precision must be a number");if(t<=0)throw new Error("precision must be greater than 0");if(t>22)throw new Error("precision cannot be greater than 22");if(Math.round(t)!==t)throw new Error("precision must be an integer")}for(var r={max:90,min:-90},o={max:180,min:-180},n="",i=0,s=0,a=1;n.length<t;){var u=a?e.longitude:e.latitude,c=a?o:r,h=(c.min+c.max)/2;u>h?(i=1+(i<<1),c.min=h):(i=0+(i<<1),c.max=h),a=!a,s<4?s++:(s=0,n+=x[i],i=0)}return n}function G(e,t){var r=V(t),o=Math.cos(r)*I*Math.PI/180*(1/Math.sqrt(1-j*Math.sin(r)*Math.sin(r)));return o<N?e>0?360:0:Math.min(360,e/o)}function Q(e,t){var r=G(e,t);return Math.abs(r)>1e-6?Math.max(1,L(360/r)):1}function z(e){return Math.min(L(P/2/e),M)}function W(e){if(e<=180&&e>=-180)return e;var t=e+180;return t>0?t%360-180:180- -t%360}function J(e,t){T(e);var r=Math.ceil(t/F);if(e.length<r)return[e,e+"~"];var o=e.substring(0,r),n=o.substring(0,o.length-1),i=x.indexOf(o.charAt(o.length-1)),s=t-n.length*F,a=F-s,u=i>>a<<a,c=u+(1<<a);return c>31?[n+x[u],n+"~"]:[n+x[u],n+x[c]]}function H(e){!function(e){try{if(!e)throw new Error("region is empty");q(e.latitude),q(e.latitudeDelta),A(e.longitude),A(e.longitudeDelta)}catch(t){throw new Error('Invalid region "'+e+'": '+t.message)}}(e);var t=Math.max(1,function(e){var t=k(e),r=t.northEast,o=t.southEast,n=t.northWest,i=t.southWest,s=2*Math.floor(z(.5*X(r,o))),a=2*Math.floor(Q(.5*X(r,n),n.latitude))-1,u=2*Math.floor(Q(.5*X(o,i),i.latitude))-1;return Math.min(s,a,u,M)}(e)),r=Math.ceil(t/F),o=function(e){var t=k(e),r=t.northEast,o=t.northWest,n=t.southWest;return[[e.latitude,e.longitude],[e.latitude,r.longitude],[e.latitude,o.longitude],[o.latitude,e.longitude],[o.latitude,r.longitude],[o.latitude,o.longitude],[n.latitude,e.longitude],[n.latitude,r.longitude],[n.latitude,o.longitude]]}(e).map(function(e){return J(B(C(e),r),t)});return o.filter(function(e,t){return!o.some(function(r,o){return t>o&&e[0]===r[0]&&e[1]===r[1]})})}function K(e,t){if(e.length!==t.length)throw new Error("Geohash lengths must be the same");for(var r=[e],o=e;o<t;)for(var n=e.length-1;n>=0;n--){var i=x.indexOf(o.charAt(n));if(i<x.length-1){(o=o.substring(0,n)+x[i+1]+o.substring(n+1))<t&&r.push(o);break}if((o=o.substring(0,n)+x[0]+o.substring(n+1))>=t)break}return r}function X(e,t){U(e),U(t);var r=V(t.latitude-e.latitude),o=V(t.longitude-e.longitude),n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(V(e.latitude))*Math.cos(V(t.latitude))*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))*1e3}var Y=function(e){function o(o,n){var i=this,a=n||{},u=a.region,c=a.fieldPath,h=void 0===c?"geohash":c,l=a.filterBy,f=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(a,["region","fieldPath","filterBy"]),d=t.observable.box(u);return(i=e.call(this,o,s({filterBy:l?function(e){var t=d.get();return t="function"==typeof t?t():t,l(e,t)}:void 0,queries:function(){var e=d.get(),t=(e="function"==typeof e?e():e)?H(e):void 0;return t?t.map(function(e){return{geohash:e,key:e[0]+"-"+e[1],query:function(t){return r.query(t,r.where(h,">=",e[0]),r.where(h,"<",e[1]))}}}):null}},f))||this).regionObservable=d,t.makeObservable(i,{geohashes:t.computed}),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(o,e),Object.defineProperty(o.prototype,"region",{get:function(){return this.regionObservable.get()},set:function(e){var r=this;t.runInAction(function(){return r.regionObservable.set(e)})},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"geohashes",{get:function(){var e=this.queries();return e?e.map(function(e){return e.geohash}):[]},enumerable:!1,configurable:!0}),o}(_);e.AggregateCollection=_,e.Collection=R,e.Document=w,e.GeoQuery=Y,e.calculateGeoDistance=X,e.decodeGeohash=function(e){T(e);for(var t=!0,r=-90,o=90,n=-180,i=180,s=0;s<e.length;s++){var a=e.charAt(s),u=x.indexOf(a);if(u<0)throw new Error("Invalid geohash");for(var c=4;c>=0;c--){var h=u>>c&1;if(t){var l=(n+i)/2;1===h?n=l:i=l}else{var f=(r+o)/2;1===h?r=f:o=f}t=!t}}return[{latitude:r,longitude:n},{latitude:o,longitude:i}]},e.encodeGeohash=B,e.flattenGeohashRange=K,e.flattenGeohashes=function(e){var t=new Set;return e.forEach(function(e){return K(e[0],e[1]).forEach(function(e){return t.add(e)})}),Array.from(t)},e.geoRegionToPoints=k,e.getFirebaseApp=function(e){return g("app",e).app},e.getFirestore=v,e.getGeohashesForRadius=function(e,t){U(e);var r,o,n,i,s,a,u,c,h=Math.max(1,(r=e,n=(o=t)/E,i=Math.min(90,r.latitude+n),s=Math.max(-90,r.latitude-n),a=2*Math.floor(z(o)),u=2*Math.floor(Q(o,i))-1,c=2*Math.floor(Q(o,s))-1,Math.min(a,u,c,M))),l=Math.ceil(h/F),f=function(e,t){var r=t/E,o=Math.min(90,e.latitude+r),n=Math.max(-90,e.latitude-r),i=G(t,o),s=G(t,n),a=Math.max(i,s);return[[e.latitude,e.longitude],[e.latitude,W(e.longitude-a)],[e.latitude,W(e.longitude+a)],[o,e.longitude],[o,W(e.longitude-a)],[o,W(e.longitude+a)],[n,e.longitude],[n,W(e.longitude-a)],[n,W(e.longitude+a)]]}(e,t).map(function(e){return J(B(C(e),l),h)});return f.filter(function(e,t){return!f.some(function(r,o){return t>o&&e[0]===r[0]&&e[1]===r[1]})})},e.getGeohashesForRegion=H,e.initFirestorter=function(e){if(d)throw new Error("Firestorter already initialized, did you accidentally call `initFirestorter()` again?");d=p(e)},e.insideGeoRegion=function(e,t){return!(e.latitude<t.latitude-.5*t.latitudeDelta||e.latitude>t.latitude+.5*t.latitudeDelta||e.longitude<t.longitude-.5*t.longitudeDelta||e.longitude>t.longitude+.5*t.longitudeDelta)},e.isTimestamp=function(e){return e instanceof Date||"object"==typeof e&&"number"==typeof e.seconds&&"number"==typeof e.nanoseconds},e.makeFirestorterContext=p,e.mergeUpdateData=h,e.metersToLatitudeDegrees=function(e){return e/E},e.metersToLongitudeDegrees=G,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("mobx"),require("firebase/firestore"),require("firebase/app")):"function"==typeof define&&define.amd?define(["exports","mobx","firebase/firestore","firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firestorter={},e.mobx,e.firestore,e.app);